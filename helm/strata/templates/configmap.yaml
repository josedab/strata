apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "strata.fullname" . }}
  labels:
    {{- include "strata.labels" . | nindent 4 }}
data:
  config.toml: |
    # Strata Configuration (Helm-managed)
    # Generated by Helm chart {{ .Chart.Name }}-{{ .Chart.Version }}

    [server]
    bind_address = "0.0.0.0"
    s3_port = {{ .Values.service.s3.port }}
    metadata_port = {{ .Values.service.metadata.port }}
    data_port = {{ .Values.service.data.port }}
    metrics_port = {{ .Values.service.metrics.port }}
    worker_threads = 0

    [storage]
    data_dir = "/var/lib/strata/data"
    metadata_dir = "/var/lib/strata/metadata"
    max_chunk_size = 67108864
    compression = "lz4"

    [raft]
    election_timeout_min_ms = {{ .Values.strata.raft.electionTimeoutMin }}
    election_timeout_max_ms = {{ .Values.strata.raft.electionTimeoutMax }}
    heartbeat_interval_ms = {{ .Values.strata.raft.heartbeatInterval }}
    snapshot_threshold = {{ .Values.strata.raft.snapshotThreshold }}
    snapshot_dir = "/var/lib/strata/metadata/snapshots"

    [erasure]
    data_shards = {{ .Values.strata.erasure.dataShards }}
    parity_shards = {{ .Values.strata.erasure.parityShards }}

    [s3]
    enabled = {{ .Values.strata.s3.enabled }}
    region = "{{ .Values.strata.s3.region }}"
    max_object_size = {{ .Values.strata.s3.maxObjectSize }}

    [cache]
    enabled = {{ .Values.strata.cache.enabled }}
    max_size_bytes = {{ .Values.strata.cache.maxSize }}
    ttl_seconds = {{ .Values.strata.cache.ttlSeconds }}

    [logging]
    level = "{{ .Values.strata.logLevel }}"
    format = "{{ .Values.strata.logFormat }}"

    [metrics]
    enabled = true
    endpoint = "/metrics"

    [health]
    liveness_path = "/health/live"
    readiness_path = "/health/ready"

    [security]
    tls_enabled = {{ .Values.strata.security.tlsEnabled }}
    auth_enabled = {{ .Values.strata.security.authEnabled }}

    [limits]
    requests_per_second = {{ .Values.strata.rateLimit.requestsPerSecond }}
    burst_size = {{ .Values.strata.rateLimit.burstSize }}
    max_connections = 10000
    connection_timeout_ms = 30000
