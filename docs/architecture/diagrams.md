# Strata Architecture Diagrams

This document provides visual representations of Strata's architecture and data flows.

## System Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Strata                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        ACCESS LAYER                                  │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │    │
│  │  │  FUSE    │  │    S3    │  │   CLI    │  │  Native  │            │    │
│  │  │  Client  │  │  Gateway │  │  Tools   │  │   SDK    │            │    │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘            │    │
│  └───────┼─────────────┼─────────────┼─────────────┼────────────────────┘    │
│          │             │             │             │                         │
│          └─────────────┴──────┬──────┴─────────────┘                         │
│                               │                                              │
│  ┌────────────────────────────┼────────────────────────────────────────┐    │
│  │                    METADATA CLUSTER                                  │    │
│  │                            │                                         │    │
│  │    ┌───────────────────────┼───────────────────────────┐            │    │
│  │    │                       ▼                           │            │    │
│  │    │  ┌─────────┐    ┌─────────┐    ┌─────────┐       │            │    │
│  │    │  │ Node 1  │◄──►│ Node 2  │◄──►│ Node 3  │       │            │    │
│  │    │  │ (Leader)│    │(Follower│    │(Follower│       │            │    │
│  │    │  └─────────┘    └─────────┘    └─────────┘       │            │    │
│  │    │        Raft Consensus Protocol                    │            │    │
│  │    └───────────────────────────────────────────────────┘            │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                               │                                              │
│                     Placement Info                                           │
│                               │                                              │
│  ┌────────────────────────────┼────────────────────────────────────────┐    │
│  │                      DATA LAYER                                      │    │
│  │                            │                                         │    │
│  │    ┌───────────┬───────────┼───────────┬───────────┐                │    │
│  │    │           │           │           │           │                │    │
│  │    ▼           ▼           ▼           ▼           ▼                │    │
│  │ ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐               │    │
│  │ │Data 1│   │Data 2│   │Data 3│   │Data 4│   │Data N│               │    │
│  │ │Server│   │Server│   │Server│   │Server│   │Server│               │    │
│  │ └──────┘   └──────┘   └──────┘   └──────┘   └──────┘               │    │
│  │                                                                      │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                     CLUSTER MANAGEMENT                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │   Placement  │  │   Recovery   │  │  Rebalancing │  │   Failure    │    │
│  │    Engine    │  │   Manager    │  │    Engine    │  │   Detector   │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Request Flow

### S3 Request Processing

```
┌──────────┐     ┌─────────────────────────────────────────────────────────────┐
│          │     │                    S3 Gateway                                │
│  Client  │────►│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌─────────┐ │
│          │     │  │   CORS   │──►│   Rate   │──►│   Auth   │──►│ Handler │ │
└──────────┘     │  │Middleware│   │  Limiter │   │ (SigV4)  │   │         │ │
                 │  └──────────┘   └──────────┘   └──────────┘   └────┬────┘ │
                 └─────────────────────────────────────────────────────┼──────┘
                                                                       │
                           ┌───────────────────────────────────────────┘
                           │
                           ▼
                 ┌──────────────────┐
                 │ Metadata Client  │──────► Raft Cluster
                 └──────────────────┘
                           │
                           ▼
                 ┌──────────────────┐
                 │   Data Client    │──────► Data Servers
                 └──────────────────┘
```

### S3 Feature Modules

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           S3 Gateway Features                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     Core Operations                                  │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │    │
│  │  │  Bucket  │  │  Object  │  │Multipart │  │   List   │            │    │
│  │  │   CRUD   │  │   CRUD   │  │  Upload  │  │ Objects  │            │    │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     Data Management                                  │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │    │
│  │  │Versioning│  │Lifecycle │  │ Storage  │  │  Object  │            │    │
│  │  │          │  │ Policies │  │  Class   │  │  Restore │            │    │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     Security & Compliance                            │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │    │
│  │  │  Server  │  │  Object  │  │   CORS   │  │   Rate   │            │    │
│  │  │Encryption│  │  Lock    │  │  Config  │  │ Limiting │            │    │
│  │  │ (SSE)    │  │  (WORM)  │  │          │  │          │            │    │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     Advanced Features                                │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                          │    │
│  │  │    S3    │  │  Bucket  │  │  SigV4   │                          │    │
│  │  │  Select  │  │Replicat° │  │   Auth   │                          │    │
│  │  │  (SQL)   │  │          │  │          │                          │    │
│  │  └──────────┘  └──────────┘  └──────────┘                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### S3 Select Query Flow

```
┌────────┐   SQL Query    ┌──────────────────────────────────────────────────┐
│ Client │───────────────►│                  S3 Select                        │
└────────┘                │                                                    │
                          │  ┌────────────┐   ┌────────────┐   ┌──────────┐  │
                          │  │   Parse    │──►│   Fetch    │──►│ Execute  │  │
                          │  │    SQL     │   │   Object   │   │  Query   │  │
                          │  └────────────┘   └────────────┘   └────┬─────┘  │
                          │                                         │        │
                          │  ┌────────────┐   ┌────────────┐       │        │
                          │  │   Format   │◄──│  Filter &  │◄──────┘        │
                          │  │   Output   │   │ Aggregate  │                 │
                          │  └─────┬──────┘   └────────────┘                 │
                          └────────┼─────────────────────────────────────────┘
                                   │
                                   ▼
                          ┌────────────────┐
                          │  CSV/JSON      │
                          │   Results      │
                          └────────────────┘

Supported SQL:
  SELECT col1, col2 FROM s3object WHERE condition
  SELECT COUNT(*), SUM(col), AVG(col), MIN(col), MAX(col) FROM s3object
```

### Object Locking (WORM) Flow

```
┌────────┐   PUT Object   ┌──────────────────────────────────────────────────┐
│ Client │───────────────►│                Object Lock Check                  │
└────────┘                └──────────────────────────────────────────────────┘
                                           │
                    ┌──────────────────────┼──────────────────────┐
                    │                      │                      │
                    ▼                      ▼                      ▼
           ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
           │  Legal Hold?  │      │  Retention    │      │  Bucket Lock  │
           │               │      │  Active?      │      │  Default?     │
           └───────┬───────┘      └───────┬───────┘      └───────┬───────┘
                   │                      │                      │
                   ▼                      ▼                      ▼
           ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
           │    ON: Block  │      │ Yes: Check    │      │ Apply Default │
           │   OFF: Allow  │      │   RetainUntil │      │   Retention   │
           └───────────────┘      └───────────────┘      └───────────────┘

Retention Modes:
  GOVERNANCE - Can be overridden with special permissions
  COMPLIANCE - Cannot be shortened by any user
```

### Write Path

```
┌────────┐   1. Create    ┌──────────┐   2. Allocate   ┌──────────┐
│ Client │──────────────►│ Metadata │───────────────►│ Placement│
└───┬────┘                │  Leader  │                │  Engine  │
    │                     └────┬─────┘                └────┬─────┘
    │                          │                           │
    │                          │ 3. Raft Replicate         │
    │                          ▼                           │
    │                     ┌──────────┐                     │
    │                     │ Followers│                     │
    │                     └──────────┘                     │
    │                                                      │
    │   4. Receive placement (server locations)            │
    │◄─────────────────────────────────────────────────────┘
    │
    │   5. Erasure encode data
    │
    │   6. Write shards in parallel
    │
    ├──────────────────────►┌──────────┐
    │                       │ Data Srv │ Shard 0
    │                       │    A     │
    │                       └──────────┘
    │
    ├──────────────────────►┌──────────┐
    │                       │ Data Srv │ Shard 1
    │                       │    B     │
    │                       └──────────┘
    │
    ├──────────────────────►┌──────────┐
    │                       │ Data Srv │ Shard 2
    │                       │    C     │
    │                       └──────────┘
    │
    └──────────────────────►┌──────────┐
                            │ Data Srv │ Parity
                            │    D     │
                            └──────────┘

    7. Commit write (update metadata)
```

### Read Path

```
┌────────┐   1. Lookup    ┌──────────┐
│ Client │───────────────►│ Metadata │
└───┬────┘                │  Cluster │
    │                     └────┬─────┘
    │                          │
    │   2. Return inode +      │
    │      chunk locations     │
    │◄─────────────────────────┘
    │
    │   3. Read shards (parallel, only need k of n)
    │
    ├──────────────────────►┌──────────┐
    │                       │ Data Srv │ Shard 0 ✓
    │                       │    A     │
    │◄──────────────────────└──────────┘
    │
    ├──────────────────────►┌──────────┐
    │                       │ Data Srv │ Shard 1 ✓
    │                       │    B     │
    │◄──────────────────────└──────────┘
    │
    ├─────────────────X────►┌──────────┐
    │                       │ Data Srv │ Shard 2 (failed)
    │                       │    C     │
    │                       └──────────┘
    │
    ├──────────────────────►┌──────────┐
    │                       │ Data Srv │ Parity ✓
    │                       │    D     │
    │◄──────────────────────└──────────┘
    │
    │   4. Erasure decode (reconstruct from available shards)
    │
    ▼
  Data
```

## Erasure Coding

### Encoding Process

```
                    Original Data (64 MB)
                            │
                            ▼
              ┌─────────────────────────────┐
              │     Reed-Solomon Encoder     │
              │         (4 data + 2 parity)  │
              └─────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │           │       │       │           │
        ▼           ▼       ▼       ▼           ▼
    ┌───────┐  ┌───────┐┌───────┐┌───────┐ ┌───────┐ ┌───────┐
    │Shard 0│  │Shard 1││Shard 2││Shard 3│ │Parity0│ │Parity1│
    │ 16 MB │  │ 16 MB ││ 16 MB ││ 16 MB │ │ 16 MB │ │ 16 MB │
    └───────┘  └───────┘└───────┘└───────┘ └───────┘ └───────┘
        │           │       │       │           │         │
        ▼           ▼       ▼       ▼           ▼         ▼
    Server A   Server B Server C Server D  Server E  Server F
```

### Reconstruction (with failures)

```
    Available Shards:           Missing:
    ┌───────┐ ┌───────┐         ┌ ─ ─ ─ ┐ ┌───────┐
    │Shard 0│ │Shard 1│           Shard 2  │Parity0│
    │   ✓   │ │   ✓   │         │   ✗   │ │   ✓   │
    └───────┘ └───────┘         └ ─ ─ ─ ┘ └───────┘
        │         │                           │
        └─────────┴───────────┬───────────────┘
                              │
                              ▼
                ┌─────────────────────────────┐
                │     Reed-Solomon Decoder     │
                │    (need any 4 of 6 shards) │
                └─────────────────────────────┘
                              │
                              ▼
                    Original Data (64 MB)
```

## Failure Detection & Recovery

### Phi Accrual Failure Detector

```
                    Heartbeat Timeline
    ────────┬────────┬────────┬────────┬────────┬───────► time
            │        │        │        │        │
            ▼        ▼        ▼        ▼        ▼
           HB       HB       HB      (miss)   (miss)
            │        │        │        │        │
            └────────┴────────┴────────┴────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  Phi Calculator │
                    │                 │
                    │  φ = -log₁₀(P)  │
                    │                 │
                    │  P = probability│
                    │  of late HB     │
                    └────────┬────────┘
                             │
                             ▼
           ┌─────────────────────────────────────┐
           │         Phi Value over Time         │
           │                                     │
     φ=8 ──┤                           ┌────────►│ FAILED
           │                      ┌────┘         │
     φ=4 ──┤                 ┌────┘              │ SUSPECTED
           │            ┌────┘                   │
     φ=1 ──┤───────────┘                         │ HEALTHY
           │                                     │
           └─────────────────────────────────────┘
```

### Self-Healing Process

```
┌─────────────────────────────────────────────────────────────────┐
│                    Recovery Manager                              │
└───────────────────────────────┬─────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│ 1. Detect     │      │ 2. Identify   │      │ 3. Reconstruct│
│    Failure    │─────►│    Under-     │─────►│    Missing    │
│               │      │    replicated │      │    Shards     │
└───────────────┘      └───────────────┘      └───────────────┘
                                                      │
        ┌─────────────────────────────────────────────┘
        │
        ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│ 4. Place on   │      │ 5. Update     │      │ 6. Verify     │
│    Healthy    │─────►│    Metadata   │─────►│    Integrity  │
│    Nodes      │      │               │      │               │
└───────────────┘      └───────────────┘      └───────────────┘
```

## Network Ports

```
┌─────────────────────────────────────────────────────────────────┐
│                         Strata Node                              │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Port 9000 - Metadata/Raft (gRPC)                        │   │
│  │  • Raft consensus messages                               │   │
│  │  • Metadata operations                                    │   │
│  │  • Internal cluster communication                         │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Port 9001 - Data Server (gRPC)                          │   │
│  │  • Chunk read/write                                       │   │
│  │  • Integrity verification                                 │   │
│  │  • Scrubbing operations                                   │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Port 9002 - S3 Gateway (HTTP)                           │   │
│  │  • S3-compatible API                                      │   │
│  │  • Rate limiting                                          │   │
│  │  • AWS SigV4 authentication                               │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Port 9090 - Metrics (HTTP/Prometheus)                   │   │
│  │  • Prometheus metrics endpoint                            │   │
│  │  • Health checks                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## See Also

- [Architecture Overview](overview.md) - Detailed component descriptions
- [S3 API](../api/s3.md) - S3 gateway documentation
- [Deployment Guide](../guides/deployment.md) - Production deployment
